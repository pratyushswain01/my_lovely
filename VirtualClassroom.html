<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zenith Classroom - UPSC Hub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/hark@1.2.3/hark.bundle.min.js"></script>
    <style>
        :root{--primary-start:#6a11cb;--primary-end:#2575fc;--primary-gradient:linear-gradient(135deg,var(--primary-start),var(--primary-end));--danger:#ff4d4f;--success:#2ecc71;--success-glow:rgba(46,204,113,0.5);--bg-dark:#101114;--surface-dark:#1c1e23;--text-primary-dark:#f5f5f5;--text-secondary-dark:#b0b3b8;--border-dark:rgba(255,255,255,.1)}*,::before,::after{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;width:100%;-webkit-font-smoothing:antialiased}body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--text-primary-dark);overflow:hidden}
        .pre-join-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(13,15,24,.7);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:100;transition:opacity .3s ease}.pre-join-card{background:var(--surface-dark);padding:40px;border-radius:20px;width:90%;max-width:500px;text-align:center;border:1px solid var(--border-dark)}.video-preview-container{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;margin-bottom:20px;overflow:hidden;position:relative}#video-preview{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}#video-preview-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--text-secondary-dark)}.pre-join-card h1{margin-bottom:10px;font-size:1.8rem}.form-group{margin-bottom:15px;text-align:left}.form-group label{display:block;margin-bottom:5px;font-size:.9rem;font-weight:500}.form-group input{width:100%;padding:12px 15px;background:var(--bg-dark);border:1px solid var(--border-dark);border-radius:8px;color:var(--text-primary-dark);font-size:1rem}#join-btn{width:100%;padding:15px;border:none;background:var(--primary-gradient);color:#fff;font-size:1.1rem;font-weight:600;border-radius:8px;cursor:pointer;margin-top:20px}#join-btn:disabled{background:#555;cursor:not-allowed}
        #classroom-container{display:none;width:100%;height:100%;flex-direction:column;position:relative}
        .main-content-wrapper{width:100%;height:100%;display:flex;transition:padding-right .4s cubic-bezier(.25,.46,.45,.94)}.main-content-wrapper.panel-open{padding-right:350px}
        .main-content{width:100%;height:100%;display:flex;flex-direction:column;padding:20px 20px 100px;position:relative}
        .top-bar{position:absolute;top:20px;left:20px;display:flex;align-items:center;gap:10px;z-index:10;background:rgba(28,30,35,.6);padding:8px 15px;border-radius:12px;border:1px solid var(--border-dark);backdrop-filter:blur(10px)}.top-bar i{font-size:1.5rem;color:var(--primary-end)}.top-bar span{font-family:'Poppins',sans-serif;font-weight:600;font-size:1.2rem}
        #video-grid{flex-grow:1;display:grid;gap:1rem;transition:all .5s ease-in-out;padding-top:60px}
        .participant-tile{background:#000;border-radius:12px;position:relative;overflow:hidden;border:2px solid transparent;transition:all .3s ease;display:grid;place-items:center;cursor:pointer;animation:zoomIn .3s ease forwards}.participant-tile .video-feed{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}.participant-tile .video-feed.screen{transform:scaleX(1)}.participant-tile .user-tag{position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,.5);padding:5px 10px;border-radius:8px;font-size:.8rem;display:flex;align-items:center;gap:8px}.participant-tile .mute-icon{color:var(--danger);display:none}.participant-tile.is-muted .mute-icon{display:inline-block}
        .is-speaking{box-shadow:0 0 15px 3px var(--success-glow);border-color:var(--success)}
        @keyframes zoomIn{from{transform:scale(.95);opacity:0}to{transform:scale(1);opacity:1}}
        .control-bar{position:fixed;bottom:0;left:0;right:0;height:80px;background:rgba(20,20,20,.8);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;gap:15px;padding:0 20px;z-index:20;border-top:1px solid var(--border-dark)}.control-btn{background:var(--surface-dark);border:none;color:var(--text-primary-dark);width:auto;min-width:55px;height:55px;padding:0 15px;border-radius:18px;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s ease}.control-btn span{font-size:.7rem;font-weight:500}.control-btn:hover{background:#3d3d3d}.control-btn.danger{background:var(--danger);color:#fff}.control-btn.active{background:var(--success)}
        .side-panel{position:fixed;top:0;right:-350px;width:100%;max-width:350px;height:100%;background:var(--surface-dark);z-index:30;transition:right .4s cubic-bezier(.25,.46,.45,.94);display:flex;flex-direction:column;border-left:1px solid var(--border-dark)}.side-panel.open{right:0}.side-panel-header{display:flex;justify-content:space-between;align-items:center;padding:20px;border-bottom:1px solid var(--border-dark)}.side-panel-header h3{font-size:1.2rem}.side-panel-header .close-btn{background:0 0;border:0;color:var(--text-secondary-dark);font-size:1.5rem;cursor:pointer}
        #participants-list{list-style:none;padding:20px;overflow-y:auto;flex-grow:1}.participant-list-item{display:flex;align-items:center;gap:10px;padding:10px}.participant-list-item .mute-icon{color:var(--danger)}
        #chat-panel{flex-grow:1;display:flex;flex-direction:column;overflow:hidden}.chat-messages{flex-grow:1;padding:20px;overflow-y:auto}.chat-message{margin-bottom:15px}.chat-message .author{font-size:.8rem;font-weight:600;color:var(--text-secondary-dark);margin-bottom:4px}.chat-message .text{background:#3d3d3d;padding:10px 15px;border-radius:12px;display:inline-block;max-width:100%;word-wrap:break-word}.chat-message.self{text-align:right}.chat-message.self .text{background:var(--primary-end)}
        .chat-input-form{display:flex;padding:20px;border-top:1px solid var(--border-dark)}.chat-input-form input{flex:1;background:var(--bg-dark);border:1px solid var(--border-dark);padding:10px 15px;border-radius:8px;color:var(--text-primary-dark);margin-right:10px}.chat-input-form button{background:var(--primary-end);border:none;color:#fff;font-weight:600;padding:0 15px;border-radius:8px;cursor:pointer}
        .speaker-view #video-grid{display:flex;flex-direction:row}.speaker-view .speaker-tile{flex-grow:1;min-width:0}.speaker-view .filmstrip{display:flex;flex-direction:column;gap:1rem;width:220px;height:100%;overflow-y:auto;padding-left:1rem}.speaker-view .filmstrip .participant-tile{width:100%;height:auto;flex-shrink:0}
        .presenter-pip{position:absolute;bottom:20px;right:20px;width:200px;height:auto;aspect-ratio:16/9;border:2px solid var(--border-dark);border-radius:12px;overflow:hidden;z-index:15;box-shadow:0 5px 20px rgba(0,0,0,.5);animation:zoomIn .3s ease forwards}
        @media(max-width:768px){.main-content-wrapper.panel-open{padding-right:0}.main-content{padding:70px 10px 90px}.top-bar{top:15px;left:15px}.control-bar{gap:10px;justify-content:space-evenly}.control-btn{min-width:48px;width:auto;height:48px;padding:0 12px;border-radius:15px}.control-btn span{display:none}
        #video-grid{display:flex;flex-direction:column;padding-top:50px}.speaker-tile{flex-grow:1}.filmstrip{display:flex;flex-direction:row;gap:10px;overflow-x:auto;padding-top:10px;height:120px;flex-shrink:0}.filmstrip .participant-tile{height:100%;width:auto;flex-grow:0}.side-panel{max-width:100%;right:-105%}.side-panel.open{right:0}}
    </style>
</head>
<body>
    <div id="pre-join-screen" class="pre-join-overlay">
         <div class="pre-join-card">
            <div class="video-preview-container"><video id="video-preview" muted></video><p id="video-preview-msg">Requesting camera access...</p></div>
            <h1 id="pre-join-title">Zenith Classroom</h1><p id="pre-join-description">Enter your name and the classroom ID to join.</p>
            <div class="form-group" id="room-id-form-group" style="display: none;"><label for="room-input">Create a new Classroom ID</label><input type="text" id="room-input" placeholder="e.g., gs-polity-batch-1"></div>
            <div class="form-group"><label for="name-input">Your Display Name</label><input type="text" id="name-input" placeholder="e.g., Pratyush Swain"></div>
            <div class="button-group"><button id="join-btn" disabled>Join Session</button></div>
        </div>
    </div>
    <div id="classroom-container">
        <!-- The classroom content remains the same -->
        <div class="main-content-wrapper" id="main-content-wrapper"><div class="main-content"><div class="top-bar"><i class="fas fa-graduation-cap"></i><span id="classroom-name-display">UPSChub</span></div><div id="video-grid"></div></div><div class="side-panel" id="side-panel"><div class="side-panel-header"><h3 id="panel-title">Participants</h3><button class="close-btn" onclick="toggleSidePanel()">Ã—</button></div><div id="participants-panel" class="panel-content-area"><ul id="participants-list"></ul></div><div id="chat-panel" class="panel-content-area" style="display: none;"><div class="chat-messages" id="chat-messages"></div><form class="chat-input-form" id="chat-form"><input type="text" id="chat-input" placeholder="Type a message..."><button type="submit"><i class="fas fa-paper-plane"></i></button></form></div></div></div><div class="control-bar"><button class="control-btn" id="mic-btn" onclick="toggleMic()"><i class="fas fa-microphone"></i><span>Mute</span></button><button class="control-btn" id="cam-btn" onclick="toggleCam()"><i class="fas fa-video"></i><span>Video</span></button><button class="control-btn" id="share-btn" onclick="toggleScreenShare()"><i class="fas fa-desktop"></i><span>Share</span></button><button class="control-btn" id="participants-btn" onclick="toggleSidePanel('participants')"><i class="fas fa-users"></i><span>Participants</span></button><button class="control-btn" id="chat-btn" onclick="toggleSidePanel('chat')"><i class="fas fa-comment-dots"></i><span>Chat</span></button><button class="control-btn" id="layout-btn" onclick="toggleLayout()"><i class="fas fa-grip"></i><span>Layout</span></button><button class="control-btn danger" id="leave-btn" onclick="leaveSession()"> <i class="fas fa-phone-slash"></i><span>Leave</span></button></div>
    </div>
<script>
    const getEl = id => document.getElementById(id);
    const preJoinScreen = getEl('pre-join-screen'), classroom = getEl('classroom-container'), joinBtn = getEl('join-btn'), nameInput = getEl('name-input'), roomInput = getEl('room-input'), videoGrid = getEl('video-grid'), sidePanel = getEl('side-panel'), mainWrapper = getEl('main-content-wrapper'), pList = getEl('participants-list'), chatPanel = getEl('chat-panel'), pPanel = getEl('participants-panel'), chatForm = getEl('chat-form'), chatInput = getEl('chat-input'), chatMessages = getEl('chat-messages');
    let localStream, screenStream, peer, myName, myPeerId, roomID, currentLayout = 'gallery', pinnedUserId = null, isSharingScreen = false;
    const peers = {}, participants = {};

    async function setupPreJoinScreen() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            getEl('video-preview').srcObject = localStream;
            getEl('video-preview').play();
            getEl('video-preview-msg').style.display = 'none';
            joinBtn.disabled = false;
        } catch (err) { getEl('video-preview-msg').textContent = "Camera/Mic access denied."; }

        
        roomID = window.location.pathname.substring(1);
        if (roomID) {
            getEl('pre-join-title').textContent = `Joining: ${roomID.replace(/-/g, ' ')}`;
            getEl('pre-join-description').textContent = "Your camera is on. Enter your name to join.";
        } else {
            getEl('pre-join-title').textContent = "Create or Join a Classroom";
            getEl('room-id-form-group').style.display = 'block';
            getEl('pre-join-description').textContent = "Enter a Classroom ID to join, or create a new one.";
        }
        nameInput.value = 'Aspirant ' + Math.floor(Math.random() * 100);
    }
    
    joinBtn.addEventListener('click', () => {
        roomID = roomID || roomInput.value.trim();
        myName = nameInput.value.trim();
        if (!myName || !roomID) return alert('Please provide your name and a classroom ID.');
        if (window.location.pathname.substring(1) !== roomID) return window.location.href = `/${roomID}`;
        
        preJoinScreen.style.opacity = '0';
        setTimeout(() => preJoinScreen.remove(), 300);
        classroom.style.display = 'flex';
        initialize(roomID);
    });

    function initialize(roomID) {
        getEl('classroom-name-display').textContent = `UPSChub | ${roomID.replace(/-/g, ' ')}`;
        const socket = io("https://upschub-zenith.onrender.com");
        peer = new Peer();

        peer.on('open', id => {
            myPeerId = id;
            socket.emit('join-room', roomID, id, myName);
        });

        socket.on('user-connected', (id, name) => {
            addParticipant(id, name);
            connectToNewUser(id, name, localStream);
        });

        socket.on('user-disconnected', id => removeParticipant(id));
        
        socket.on('update-participant-list', serverList => updateFullParticipantList(serverList));

        peer.on('call', call => {
            call.answer(localStream);
            const tile = getEl(`tile-${call.peer}`) || createVideoTile(call.peer);
            call.on('stream', userStream => addVideoStream(tile, userStream, call.metadata.userName));
            peers[call.peer] = call;
        });

        peer.on('connection', conn => setupDataConnection(conn));
    }
    
    function addParticipant(id, name, isSelf = false) {
        if(getEl(`tile-${id}`)) return;
        const tile = createVideoTile(id, name);
        if (isSelf) {
            addVideoStream(tile, localStream, true);
            setupSpeakingIndicator(tile, localStream);
        }
        updateLayout();
    }
    
    // All other functions are provided for completeness, based on the last stable version.
    function removeParticipant(id){delete participants[id],delete peers[id],getEl(`tile-${id}`)?.remove(),pinnedUserId===id&&(pinnedUserId=null),updateLayout()}function addVideoStream(e,t,o=!1){let i=e.querySelector("video");i||(i=document.createElement("video"),e.prepend(i)),i.srcObject=t,i.muted=o,i.className=t.getVideoTracks()[0]?.getSettings().cursor?"video-feed screen":"video-feed",i.play()}
    function connectToNewUser(id,name,stream){const e=peer.call(id,stream,{metadata:{userName:myName}});const t=createVideoTile(id);e.on("stream",e=>addVideoStream(t,e,name)),e.on("close",()=>removeParticipant(id)),peers[id]=e;const o=peer.connect(id);setupDataConnection(o)}function setupDataConnection(e){e.on("open",()=>{dataConnections[e.peer]=e,e.send({type:"user_info",userId:myPeerId,name:myName,isMuted:!localStream.getAudioTracks()[0].enabled})}),e.on("data",e=>handleDataMessage(e))}function broadcastData(e){Object.values(dataConnections).forEach(t=>t?.send(e))}function handleDataMessage({type:e,userId:t,name:o,isMuted:i,sender:a,message:n}){"user_info"===e&&updateMuteStatus(t,i),"mute_status"===e&&updateMuteStatus(t,i),"chat"===e&&displayChatMessage(a,n)}
    function createVideoTile(id,name){if(getEl(`tile-${id}`))return getEl(`tile-${id}`);const e=document.createElement("div");return e.id=`tile-${id}`,e.className="participant-tile",e.onclick=()=>pinUser(id),e.innerHTML=`<div class="user-tag"><span>${name}</span><i class="fas fa-microphone-slash mute-icon"></i></div>`,videoGrid.append(e),e}
    function updateLayout(){const e=Object.keys(participants).length+1;videoGrid.innerHTML="";if(window.innerWidth<=768){let t=pinnedUserId||Object.keys(participants).find(t=>participants[t]?.isSpeaking)||myPeerId;const o=getEl(`tile-${t}`)||createVideoTile(t,participants[t]?.name),i=document.createElement("div");i.className="filmstrip",o.classList.add("speaker-tile"),videoGrid.append(o,i),Object.keys(participants).filter(e=>e!==t).forEach(e=>i.append(getEl(`tile-${e}`)||createVideoTile(e,participants[e]?.name)))}else if("speaker"===currentLayout&&e>1){videoGrid.className="speaker-view";let t=pinnedUserId||Object.keys(participants).find(t=>participants[t]?.isSpeaking)||myPeerId;const o=getEl(`tile-${t}`)||createVideoTile(t,participants[t]?.name),i=document.createElement("div");i.className="filmstrip",o.classList.add("speaker-view-tile"),videoGrid.append(o,i),Object.keys(participants).filter(e=>e!==t).forEach(e=>i.append(getEl(`tile-${e}`)||createVideoTile(e,participants[e]?.name)))}else{videoGrid.className="gallery-view",Object.keys(participants).forEach(t=>videoGrid.append(getEl(`tile-${t}`)||createVideoTile(t,participants[t]?.name)));const t=Math.ceil(Math.sqrt(e)),o=Math.ceil(e/t);videoGrid.style.gridTemplateColumns=`repeat(${t}, 1fr)`,videoGrid.style.gridTemplateRows=`repeat(${o}, 1fr)`}}
    function pinUser(e){"speaker"===currentLayout&&(pinnedUserId=pinnedUserId===e?null:e,document.querySelectorAll(".participant-tile").forEach(e=>e.classList.remove("is-pinned")),pinnedUserId&&getEl(`tile-${e}`).classList.add("is-pinned"),updateLayout())}
    function setupSpeakingIndicator(e,t){hark(t,{threshold:-65}).on("speaking",()=>{document.querySelectorAll(".is-speaking").forEach(e=>e.classList.remove("is-speaking")),e.classList.add("is-speaking");const t=e.id.substring(5);if(participants[t])participants[t].isSpeaking=!0;pinnedUserId||updateLayout()})}
    function updateFullParticipantList(e){pList.innerHTML="",getEl("participants-btn").innerHTML=`<i class="fas fa-users"></i><span>Participants (${e.length})</span>`,e.forEach(e=>{participants[e.peerId]||(participants[e.peerId]={}),participants[e.peerId].name=e.name,updateMuteStatus(e.peerId,e.isMuted);const t=document.createElement("li");t.className="participant-list-item",t.innerHTML=`<i class="fas fa-user"></i><span>${e.name} ${e.peerId===myPeerId?"(You)":""}</span><i class="fas fa-microphone-slash mute-icon"></i>`,t.querySelector(".mute-icon").style.display=e.isMuted?"inline":"none",pList.append(t)}),updateLayout()}
    function updateMuteStatus(e,t){if(participants[e]){participants[e].isMuted=t;const o=getEl(`tile-${e}`);o&&(o.querySelector(".mute-icon").style.display=t?"flex":"none")}}
    function toggleMic(){const e=localStream.getAudioTracks()[0],t=!e.enabled;e.enabled=t,getEl("mic-btn").classList.toggle("danger",t),broadcastData({type:"mute_status",userId:myPeerId,isMuted:t}),updateMuteStatus(myPeerId,t)}function toggleCam(){const e=localStream.getVideoTracks()[0];e.enabled=!e.enabled,getEl("cam-btn").classList.toggle("danger",!e.enabled)}
    async function toggleScreenShare(){const e=getEl("share-btn");if(isSharingScreen){isSharingScreen=!1,e.classList.remove("active"),screenStream.getTracks().forEach(e=>e.stop()),replaceTrack(localStream.getVideoTracks()[0]),document.querySelector(".presenter-pip")?.remove(),pinnedUserId===myPeerId&&(pinnedUserId=null)}else try{screenStream=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),isSharingScreen=!0,e.classList.add("active"),replaceTrack(screenStream.getVideoTracks()[0],!0),pinUser(myPeerId);const t=document.createElement("div");t.className="presenter-pip",addVideoStream(t,localStream,myName,!0),videoGrid.querySelector(".speaker-view-tile")?.append(t),screenStream.getVideoTracks()[0].onended=()=>toggleScreenShare()}catch(e){console.error("Share failed",e),isSharingScreen=!1,e.classList.remove("active")}updateLayout()}
    function replaceTrack(e){Object.values(peers).forEach(t=>t.peerConnection.getSenders().find(e=>"video"===e.track.kind)?.replaceTrack(e))}
    function toggleLayout(){currentLayout=currentLayout==='gallery'?'speaker':'gallery';getEl('layout-btn').querySelector('i').className=currentLayout==='gallery'?'fas fa-grip':'fas fa-th';updateLayout()}
    function toggleSidePanel(e){const t=getEl("side-panel"),o=getEl("main-content-wrapper");if(e&&t.classList.contains("open")&&getEl("panel-title").textContent.toLowerCase().includes(e))t.classList.remove("open"),o.classList.remove("panel-open");else if(e){t.classList.add("open"),o.classList.add("panel-open"),getEl("panel-title").textContent=e.charAt(0).toUpperCase()+e.slice(1);const i="participants"===e;pPanel.style.display=i?"block":"none",chatPanel.style.display=i?"none":"flex"}else t.classList.remove("open"),o.classList.remove("panel-open")}
    function leaveSession(){window.location.href=window.location.origin}chatForm.addEventListener("submit",e=>{e.preventDefault();const t=chatInput.value;if(!t)return;displayChatMessage(myName,t,!0);broadcastData({type:'chat',sender:myName,message:t});chatInput.value=''});function displayChatMessage(e,t,o){const i=document.createElement('div');i.className=`chat-message ${o?"self":""}`,i.innerHTML=`<div class="author">${e}</div><div class="text">${t}</div>`,chatMessages.append(i),chatMessages.scrollTop=chatMessages.scrollHeight}
    window.addEventListener('resize', updateLayout);
    
    window.addEventListener('load', setupPreJoinScreen);
</script>
</body>
</html>
