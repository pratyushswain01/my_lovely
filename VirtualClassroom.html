<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPSChub - Exam Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* General Styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #f0f0f5;
      color: #333;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
    }
    .dark { background: #1e1e2f; color: #eee; }

    /* Pre-Exam (Login & Instructions) Styles */
    .pre-exam-screen {
        display: none; flex-direction: column; align-items: center; justify-content: center;
        height: 100vh; padding: 20px; background: #f0f2f5;
    }
    .dark .pre-exam-screen { background: #1a1a2e; }
    .card {
        background: #ffffff; padding: 40px; border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); width: 100%;
        max-width: 450px; text-align: center;
    }
    .dark .card { background: #2a2a3a; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
    .card h2 { margin-bottom: 25px; color: #3f51b5; font-size: 1.8em; }
    .dark .card h2 { color: #8ab4f8; }
    .input-group { margin-bottom: 20px; text-align: left; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .input-group input { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
    .dark .input-group input { background: #1e1e2f; border-color: #555; color: #eee; }
    .btn-primary { width: 100%; padding: 12px; border: none; border-radius: 6px; background: #3f51b5; color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    .btn-primary:hover:not(:disabled) { background: #303f9f; }
    .btn-primary:disabled { background: #aab1d6; cursor: not-allowed; }
    #loginError { color: #f44336; height: 1.2em; margin-top: 15px; font-weight: 500; }
    #instructionsScreen ul { list-style-position: inside; text-align: left; margin-bottom: 25px; line-height: 1.7; }
    #instructionsScreen ul li { margin-bottom: 10px; }
    #instructionsScreen ul li strong { color: #c62828; }
    .dark #instructionsScreen ul li strong { color: #ef9a9a; }
    #offlineStatus { margin-top: 20px; padding: 10px; border-radius: 6px; font-weight: 500; transition: all 0.3s; }
    .status-waiting { background-color: #fff3e0; color: #e65100; }
    .dark .status-waiting { background-color: #4a2c0f; color: #ffe0b2; }
    .status-ready { background-color: #e8f5e9; color: #1b5e20; }
    .dark .status-ready { background-color: #1a311b; color: #c8e6c9; }
    

    /* ==== EXAM UI STYLES (MATCHING THE REFERENCE) ==== */
    #examContainer { display: none; }
    
    body.exam-active::after {
        content: "UPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub \AUPSChub UPSChub UPSChub \A...";
        position: fixed; top: -75%; left: -230%; width: 530%; height: 250%; font-size: 4vw;
        font-weight: 600; color: rgba(0, 0, 0, 0.05); text-align: center; line-height: 2.5; 
        transform: rotate(-30deg); z-index: 2; pointer-events: none; white-space: pre;
    }
    .dark.exam-active::after { color: rgba(255, 255, 255, 0.05); }

    .container { display: flex; flex-direction: column; height: 100%; position: relative; }
    
    /* Site Header Styles */
    .site-header {
      background: #ffffff; padding: 10px 20px; display: flex; align-items: center; gap: 15px;
      border-bottom: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 101;
    }
    .site-logo { height: 40px; width: auto; }
    .site-branding .site-title { font-size: 1.4em; font-weight: 700; color: #3f51b5; line-height: 1.1; }
    .site-branding .site-tagline { font-size: 0.8em; color: #666; margin: 0; }
    
    /* Topbar Styles */
    .topbar {
      display: flex; align-items: center; justify-content: space-between; padding: 8px 20px;
      background: #3f51b5; color: white; gap: 10px; z-index: 100; position: relative;
    }
    .topbar-left-group { display: flex; align-items: center; gap: 15px; }
    .topbar-right-group { display: flex; align-items: center; gap: 15px; }
    .navigation-tabs { display: flex; gap: 5px; background: rgba(0,0,0,0.15); border-radius: 6px; padding: 3px; position: absolute; left: 50%; transform: translateX(-50%); }
    .nav-tab { background: transparent; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s; font-size: 0.85em; }
    .nav-tab:hover:not(.locked) { background: rgba(255,255,255,0.2); }
    .nav-tab.active { background: white; color: #3f51b5; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .nav-tab.locked { cursor: not-allowed; opacity: 0.6; position: relative; pointer-events: none; }
    .nav-tab.locked::after { content: '\f023'; font-family: "Font Awesome 6 Free"; font-weight: 900; margin-left: 8px; font-size: 0.9em; }
    .timer { font-size: 0.95em; font-weight: bold; white-space: nowrap; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
    
    .dark-mode-toggle { display: flex; align-items: center; gap: 8px; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: #4caf50; }
    input:checked + .toggle-slider:before { transform: translateX(24px); }
    .toggle-label { font-size: 0.9em; white-space: nowrap; }
    
    .topbar #btnSubmitTest {
        background: #f44336; color: white; border: none; border-radius: 6px; font-weight: 500;
        cursor: pointer; transition: all 0.2s; display: flex; align-items: center;
        justify-content: center; gap: 6px; font-size: 0.85em; padding: 8px 15px;
    }
     .topbar #btnSubmitTest:hover { opacity: 0.85; }
    
    .main-content { flex: 1; display: flex; overflow: hidden; position: relative; }
    .question-area { width: 100%; padding: 20px; overflow-y: auto; padding-bottom: 100px; transition: padding-right 0.3s ease, filter 0.3s ease; position: relative; z-index: 2; }
    body.sidebar-open .question-area { filter: blur(4px); pointer-events: none; }
    
    .question-header { font-size: 1.2em; margin-bottom: 15px; font-weight: 600; }
    .question-timer-bar-container { width: 100%; height: 8px; background-color: #e0e0e0; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
    .question-timer-bar { height: 100%; width: 100%; background-color: #3f51b5; border-radius: 4px; }
    .question-content { margin-bottom: 20px; line-height: 1.6; font-size: 1em; }
    .options-list { list-style: none; display: grid; grid-template-columns: 1fr; gap: 10px; padding: 0; }
    .option { padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; background: white; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .option.selected { background: #4caf50; color: white; border-color: #4caf50; }
    .option-radio { margin-right: 12px; min-width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; }
    .option.selected .option-radio { border-color: white; background: white; box-shadow: inset 0 0 0 4px #4caf50; }
    
    .sidebar { position: fixed; top: 111px; right: -300px; width: 300px; height: calc(100% - 111px); background: #f8f9fa; border-left: 1px solid #ccc; display: flex; flex-direction: column; transition: right 0.3s ease-in-out; z-index: 200; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
    body.sidebar-open .sidebar { right: 0; }
    .sidebar-content { padding: 15px; overflow-y: auto; flex-grow: 1;}
    .palette-title { font-weight: 600; margin-bottom: 10px; color: #3f51b5; font-size: 1.1em; text-align: center; }
    .question-palette { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 8px; margin-bottom: 20px; }
    .question-number { width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid transparent; cursor: pointer; font-weight: 500; font-size: 13px; margin: 0 auto; }
    .answered { background: #4caf50; color: white; border: 1px solid #388e3c;}
    .not-answered { background: #f44336; color: white; border: 1px solid #d32f2f;}
    .marked { background: #ff9800; color: white; border: 1px solid #f57c00;}
    .marked-answered { background: linear-gradient(135deg, #4caf50 50%, #ff9800 50%); color: white; }
    .not-visited { background: #e9ecef; color: #333; border: 1px solid #ddd;}
    .current { border: 2px solid #3f51b5; transform: scale(1.1); }
    
    .palette-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; padding: 12px; background: #e0e0e0; border-radius: 6px; font-size: 0.8em; }
    .summary-item { display: flex; align-items: center; gap: 8px; color: #333; }
    .summary-item span { font-weight: 700; background-color: #fff; border-radius: 50%; min-width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    .legend { margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;}
    .legend-title { font-weight: 600; margin-bottom: 12px; color: #3f51b5; font-size: 1em; }
    .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85em; padding: 6px 8px; border-radius: 4px; }
    .legend-color { width: 16px; height: 16px; border-radius: 3px; margin-right: 10px; flex-shrink: 0; }
    .legend-answered { background: #4caf50; }
    .legend-not-answered { background: #f44336; }
    .legend-marked { background: #ff9800; }
    .legend-marked-answered { background: linear-gradient(135deg, #4caf50 50%, #ff9800 50%); }
    .legend-not-visited { background: #e9ecef; border: 1px solid #ccc; }
    
    .sidebar-toggle { position: fixed; top: 120px; right: 15px; z-index: 300; background: #3f51b5; border: none; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.3); color: white; transition: all 0.3s ease; }
    body.sidebar-open .sidebar-toggle { right: 315px; transform: rotate(180deg); }

    .fixed-action-area { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #ccc; padding: 10px 15px; z-index: 100; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); }
    .action-buttons { display: flex; justify-content: center; align-items: center; gap: 8px; }
    .btn-action { padding: 8px; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85em; flex-grow: 1; flex-basis: 0; }
    #btnPrevQuestion { background: #6c757d; color: white; }
    #btnSaveNext { background: #4caf50; color: white; }
    #btnMarkReview { background: #ff9800; color: white; }
    #btnClearResponse { background: #f44336; color: white; }
    .submit-button { background: #3f51b5; color: white; padding: 10px 25px; flex-grow: 0; border:none; border-radius:6px; font-weight:500; cursor:pointer;} 
    
    #resultScreenWrapper { display: none; flex-direction: column; flex: 1; overflow-y: auto; position: relative; z-index: 5; padding: 20px;}
    #resultScreenWrapper h2 { font-size: 2.5em; color: #3f51b5; margin-bottom: 5px; text-align: center; }
    #resultScreenWrapper > p { font-size: 1.2em; margin-bottom: 20px; text-align: center; }
    #finalScore { font-weight: 700; font-size: 2.2em; color: #4caf50; letter-spacing: 1px; }
    .result-buttons { display: flex; gap: 15px; margin-top: 30px; margin-bottom: 30px; justify-content: center;}
    
    .performance-analysis-container, .chart-container { width: 100%; max-width: 800px; margin: 30px auto; background: #ffffff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .performance-analysis-container h3 { text-align: center; margin-bottom: 20px; font-size: 1.5em; color: #3f51b5; }
    .table-wrapper { overflow-x: auto; }
    .performance-table { width: 100%; border-collapse: collapse; }
    .performance-table th, .performance-table td { padding: 14px 10px; text-align: center; border-bottom: 1px solid #e0e0e0; font-size: 0.95em; white-space: nowrap; }
    .performance-table th { background-color: #f8f9fa; font-weight: 600; color: #444; }
    .performance-table td:first-child { text-align: left; font-weight: 500; width: 40%; white-space: normal; }
    .accuracy-bar-container { background-color: #e9ecef; border-radius: 10px; position: relative; height: 22px; overflow: hidden; min-width: 100px; }
    .accuracy-bar { height: 100%; border-radius: 10px; }
    .accuracy-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 600; font-size: 0.9em; color: #333; text-shadow: 0 0 2px rgba(255,255,255,0.7); }

    /* Dark Mode Overrides */
    .dark .site-header, .dark .fixed-action-area { background: #2a2a3a; border-color: #3a3a4a; }
    .dark .site-branding .site-title, .dark .palette-title, .dark .legend-title { color: #8ab4f8; }
    .dark .site-branding .site-tagline { color: #aaa; }
    .dark .option { background: #2c2c3c; border-color: #444; color: #eee; }
    .dark .option.selected { background: #1b5e20; color: #c8e6c9; border-color: #81c784; }
    .dark .option.selected .option-radio { border-color: #c8e6c9; background: #c8e6c9; box-shadow: inset 0 0 0 4px #1b5e20; }
    .dark .sidebar { background: #2a2a3a; border-left: 1px solid #444;}
    .dark .not-visited { background: #3d3d4a; color: #eee; border: 1px solid #555; }
    .dark .palette-summary { background: #1e1e2f; border: 1px solid #444;}
    .dark .summary-item { color: #ccc; }
    .dark .summary-item span { background-color: #3d3d4a; color: #eee; }
    .dark .legend-item { background: rgba(255,255,255,0.05); }
    .dark #resultScreenWrapper h2, .dark .performance-analysis-container h3 { color: #8ab4f8; }
    .dark #finalScore { color: #81c784; }
    .dark .performance-analysis-container, .dark .chart-container { background: #2a2a3a; }
    .dark .performance-table th { background-color: #1e1e2f; color: #ccc; }
    .dark .performance-table td { border-bottom-color: #444; }
    .dark .accuracy-bar-container { background-color: #3d3d4a; }
    .dark .accuracy-text { color: #fff; text-shadow: none; }
  </style>
</head>
<body>

  <!-- STAGE 1: LOGIN SCREEN -->
  <div id="loginScreen" class="pre-exam-screen">
    <div class="card">
        <h2>Exam Portal Login</h2>
        <div class="input-group"> <label for="userIdInput">User ID</label> <input type="text" id="userIdInput" value="admin" placeholder="Enter User ID"> </div>
        <div class="input-group"> <label for="passwordLoginInput">Password</label> <input type="password" id="passwordLoginInput" value="password123" placeholder="Enter Password"> </div>
        <button id="loginBtn" class="btn-primary">Login</button> <p id="loginError"></p>
    </div>
  </div>

  <!-- STAGE 2: INSTRUCTIONS SCREEN -->
  <div id="instructionsScreen" class="pre-exam-screen">
    <div class="card">
        <h2>Exam Instructions</h2>
        <ul>
            <li>This is a sample test with 15 questions.</li>
            <li>Each question has a 12-second timer for auto-advancement.</li>
            <li>If internet is detected during the exam, it will auto-submit.</li>
            <li><strong>Enable Aeroplane/Flight Mode on your device now.</strong></li>
        </ul>
        <div id="offlineStatus" class="status-waiting"> <i class="fas fa-wifi"></i> Please turn on Aeroplane Mode to begin. </div>
        <button id="startExamBtn" class="btn-primary" disabled>Start Exam</button>
    </div>
  </div>

  <!-- STAGE 3: EXAM UI CONTAINER -->
  <div id="examContainer">
    <div class="container">
      <header class="site-header">
        <img src="https://via.placeholder.com/150x50/3f51b5/ffffff?text=LOGO" alt="UPSChub Logo" class="site-logo">
        <div class="site-branding"> <div class="site-title">UPSChub</div> <p class="site-tagline">Civil Services Exam Preparation</p> </div>
      </header>

      <header class="topbar">
        <div class="topbar-left-group"> <div class="timer" id="timer">02:30:00</div> </div>
        <div class="navigation-tabs">
          <button id="showMockTestTab" class="nav-tab active">Mock Test</button>
          <button id="showAnswerWritingTab" class="nav-tab locked">Answer Writing</button>
        </div>
        <div class="topbar-right-group">
          <div class="dark-mode-toggle"> <span class="toggle-label">Dark</span> <label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="toggle-slider"></span></label> </div>
          <button id="btnSubmitTest"><i class="fas fa-paper-plane"></i> Submit</button>
        </div>
      </header>

      <div class="main-content">
        <div id="mockTestWrapper" style="display: flex; width: 100%;">
          <button id="btnToggleSidebar" class="sidebar-toggle"><i class="fas fa-chevron-left"></i></button>
          <section class="question-area">
            <h2 class="question-header" id="questionNumber"></h2>
            <div class="question-timer-bar-container"> <div id="questionTimerBar" class="question-timer-bar"></div> </div>
            <div class="question-content" id="questionText"></div>
            <ul class="options-list" id="optionsList"></ul>
          </section>
          <aside class="sidebar">
            <div class="sidebar-content">
              <div class="palette-title">Question Palette</div>
              <div class="question-palette" id="questionPalette"></div>
              <div class="palette-summary">
                <div class="summary-item"><span id="summaryAnswered">0</span> Answered</div>
                <div class="summary-item"><span id="summaryNotAnswered">0</span> Not Answered</div>
                <div class="summary-item"><span id="summaryMarked">0</span> Marked for Review</div>
                <div class="summary-item"><span id="summaryNotVisited">0</span> Not Visited</div>
              </div>
              <div class="legend">
                <div class="legend-title">Legend</div>
                <div class="legend-item"><div class="legend-color answered"></div><span>Answered</span></div>
                <div class="legend-item"><div class="legend-color not-answered"></div><span>Not Answered</span></div>
                <div class="legend-item"><div class="legend-color marked"></div><span>Marked</span></div>
                <div class="legend-item"><div class="legend-color marked-answered"></div><span>Marked & Answered</span></div>
                <div class="legend-item"><div class="legend-color not-visited"></div><span>Not Visited</span></div>
              </div>
            </div>
          </aside>
        </div>
        
        <div id="resultScreenWrapper">
            <h2>Test Completed!</h2>
            <p>Your final score is:</p>
            <p id="finalScore">0/0</p>
            <div class="performance-analysis-container">
                <h3>Topic-wise Performance</h3>
                <div class="table-wrapper">
                    <table class="performance-table">
                        <thead><tr><th>Topic</th><th>Correct</th><th>Attempted</th><th>Accuracy</th></tr></thead>
                        <tbody id="performanceTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="chart-container"> <canvas id="performanceChart"></canvas> </div>
        </div>
      </div>

      <div class="fixed-action-area" id="mcqFooter">
        <div class="action-buttons">
          <button class="btn-action" id="btnPrevQuestion"><i class="fas fa-arrow-left"></i><span>Previous</span></button>
          <button class="btn-action" id="btnClearResponse"><i class="fas fa-ban"></i><span>Clear</span></button>
          <button class="btn-action" id="btnMarkReview"><i class="fas fa-flag"></i><span>Mark</span></button>
          <button class="btn-action" id="btnSaveNext"><i class="fas fa-check"></i><span>Save & Next</span></button>
        </div>
      </div>
    </div>
  </div>

 <script>
    const CORRECT_USER_ID = "admin";
    const CORRECT_PASSWORD = "password123";
    const TEST_DURATION_SECONDS = 150 * 60; 
    const PER_QUESTION_TIME = 12; 
    const questions = [
        { topic: "Union & Territory", text: "Article 1 of the Constitution describes India as a:", options: ["Federation of States", "Union of States", "Confederation of States", "Quasi-Federal State"], answer: 1 },
        { topic: "Union & Territory", text: "The power to admit new states into the Union is vested in:", options: ["The President", "The Parliament", "The Supreme Court", "The Prime Minister"], answer: 1 },
        { topic: "Union & Territory", text: "The integration of princely states was primarily the responsibility of:", options: ["Jawaharlal Nehru", "Dr. B.R. Ambedkar", "Sardar Vallabhbhai Patel", "Lord Mountbatten"], answer: 2 },
        { topic: "Citizenship", text: "India's citizenship provisions are enshrined in which part of the Constitution?", options: ["Part I", "Part II", "Part III", "Part IV"], answer: 1 },
        { topic: "Citizenship", text: "Indian citizenship can be lost through:", options: ["Renunciation", "Termination", "Deprivation", "All of the above"], answer: 3 },
        { topic: "Citizenship", text: "The concept of single citizenship is adopted from:", options: ["USA", "Canada", "Australia", "Britain"], answer: 3 },
        { topic: "Fundamental Rights", text: "The Right to Equality is guaranteed under which articles?", options: ["14-18", "19-22", "23-24", "25-28"], answer: 0 },
        { topic: "Fundamental Rights", text: "Which writ is known as a bulwark of individual liberty against arbitrary detention?", options: ["Mandamus", "Habeas Corpus", "Certiorari", "Quo-Warranto"], answer: 1 },
        { topic: "Fundamental Rights", text: "Right to Education (Article 21A) was added by which constitutional amendment?", options: ["42nd", "44th", "86th", "91st"], answer: 2 },
        { topic: "DPSP", text: "Which part of the Constitution contains the Directive Principles of State Policy?", options: ["Part III", "Part IV", "Part V", "Part VI"], answer: 1 },
        { topic: "DPSP", text: "Organizing village panchayats (Article 40) is based on which ideology?", options: ["Socialistic", "Gandhian", "Liberal-Intellectual", "Communist"], answer: 1 },
        { topic: "DPSP", text: "Are Directive Principles enforceable in a court of law?", options: ["Yes", "No", "Only in certain cases", "At the discretion of the court"], answer: 1 },
        { topic: "Fundamental Duties", text: "Fundamental Duties were added by the recommendation of:", options: ["Sarkaria Commission", "Swaran Singh Committee", "M.M. Punchhi Commission", "Venkatachaliah Commission"], answer: 1 },
        { topic: "Fundamental Duties", text: "The duty to protect and improve the natural environment is mentioned under:", options: ["Fundamental Rights", "DPSP", "Fundamental Duties", "Both DPSP and Fundamental Duties"], answer: 3 },
        { topic: "Fundamental Duties", text: "Which one of the following is NOT a Fundamental Duty?", options: ["To abide by the constitution", "To protect public property", "To cast a vote", "To promote harmony"], answer: 2 }
    ];
    
    let state = {}, onTimerEnd, mainTimerInterval, timeLeft = TEST_DURATION_SECONDS, isTestCompleted = false, performanceChart;
    
    const dom = {
        body: document.body,
        loginScreen: document.getElementById('loginScreen'), instructionsScreen: document.getElementById('instructionsScreen'),
        examContainer: document.getElementById('examContainer'), loginBtn: document.getElementById('loginBtn'),
        userIdInput: document.getElementById('userIdInput'), passwordInput: document.getElementById('passwordLoginInput'),
        loginError: document.getElementById('loginError'), startExamBtn: document.getElementById('startExamBtn'),
        offlineStatus: document.getElementById('offlineStatus'), mockTestWrapper: document.getElementById('mockTestWrapper'),
        resultScreenWrapper: document.getElementById('resultScreenWrapper'), mcqFooter: document.getElementById('mcqFooter'),
        questionText: document.getElementById('questionText'), questionNumber: document.getElementById('questionNumber'),
        questionTimerBar: document.getElementById('questionTimerBar'), optionsList: document.getElementById('optionsList'),
        questionPalette: document.getElementById('questionPalette'), btnSubmitTest: document.getElementById('btnSubmitTest'),
        btnPrevQuestion: document.getElementById('btnPrevQuestion'), btnSaveNext: document.getElementById('btnSaveNext'),
        btnMarkReview: document.getElementById('btnMarkReview'), btnClearResponse: document.getElementById('btnClearResponse'),
        timer: document.getElementById('timer'), darkModeToggle: document.getElementById('darkModeToggle'),
        finalScore: document.getElementById('finalScore'), performanceTableBody: document.getElementById('performanceTableBody'),
        sidebarToggle: document.getElementById('btnToggleSidebar'),
        summaryAnswered: document.getElementById('summaryAnswered'),
        summaryNotAnswered: document.getElementById('summaryNotAnswered'),
        summaryMarked: document.getElementById('summaryMarked'),
        summaryNotVisited: document.getElementById('summaryNotVisited'),
    };
    
    function handleLogin() {
        if (dom.userIdInput.value === CORRECT_USER_ID && dom.passwordInput.value === CORRECT_PASSWORD) {
            dom.loginScreen.style.display = 'none'; dom.instructionsScreen.style.display = 'flex';
        } else {
            dom.loginError.textContent = 'Invalid User ID or Password.';
        }
    }

    function checkOnlineStatus() {
        if (!navigator.onLine) {
            dom.offlineStatus.innerHTML = '<i class="fas fa-check-circle"></i> You are offline. Ready to begin.';
            dom.offlineStatus.className = 'status-ready'; dom.startExamBtn.disabled = false;
        } else {
            dom.offlineStatus.innerHTML = '<i class="fas fa-wifi"></i> Please enable Aeroplane Mode to begin.';
            dom.offlineStatus.className = 'status-waiting'; dom.startExamBtn.disabled = true;
        }
    }
    
    function forceSubmitOnReconnect() { if (!isTestCompleted) { alert("Internet connection detected. Submitting the test automatically as per exam rules."); submitTest(true); } }
    
    function startExam() {
        dom.instructionsScreen.style.display = 'none'; dom.examContainer.style.display = 'block';
        document.body.classList.add('exam-active');
        window.removeEventListener('online', checkOnlineStatus); window.removeEventListener('offline', checkOnlineStatus);
        window.addEventListener('online', forceSubmitOnReconnect); initTest();
    }

    function resetState() { state = { current: 0, answers: Array(questions.length).fill(null), marked: Array(questions.length).fill(false), visited: Array(questions.length).fill(false) }; }
    function initTest() { resetState(); isTestCompleted = false; timeLeft = TEST_DURATION_SECONDS; state.visited[0] = true; loadQuestion(0); startTimer(); }
    
    function loadQuestion(index) {
        state.current = index; if (!state.visited[index]) { state.visited[index] = true; }
        startQuestionTimer();
        const q = questions[index];
        dom.questionNumber.textContent = `Question ${index + 1}`;
        dom.questionText.textContent = q.text; dom.optionsList.innerHTML = '';
        q.options.forEach((opt, i) => {
            const li = document.createElement('li');
            li.className = 'option'; if (state.answers[index] === i) li.classList.add('selected');
            li.innerHTML = `<span class="option-radio"></span><span class="option-text">${opt}</span>`;
            li.onclick = () => selectOption(i); dom.optionsList.appendChild(li);
        });
        dom.btnSubmitTest.style.display = (state.current === questions.length - 1) ? 'flex' : 'none';
        updatePalette(); updateNavigationButtons();
    }

    function selectOption(optIndex) {
        state.answers[state.current] = optIndex;
        dom.optionsList.querySelectorAll('.option').forEach((opt, i) => opt.classList.toggle('selected', i === optIndex));
        updatePalette();
    }

    function handleSaveAndNext() { if (isTestCompleted) return; if (state.current < questions.length - 1) loadQuestion(state.current + 1); else submitTest(true); }
    function handleMarkAndNext() { if (isTestCompleted) return; state.marked[state.current] = true; handleSaveAndNext(); }
    function handleClearResponse() { state.answers[state.current] = null; dom.optionsList.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected')); updatePalette(); }
    
    function submitTest(isForced = false) {
        if (isTestCompleted) return;
        if (!isForced && !confirm('Are you sure you want to submit the test?')) return;
        stopTimer(); isTestCompleted = true; window.removeEventListener('online', forceSubmitOnReconnect);
        
        const score = state.answers.reduce((acc, ans, i) => (ans === questions[i].answer ? acc + 1 : acc), 0);
        dom.mockTestWrapper.style.display = 'none'; dom.mcqFooter.style.display = 'none';
        dom.sidebarToggle.style.display = 'none'; document.body.classList.remove('sidebar-open');
        showResultScreen(`${score} / ${questions.length}`, calculateTopicStats());
        dom.resultScreenWrapper.style.display = 'flex';
    }
    
    function updatePalette() {
        dom.questionPalette.innerHTML = ''; let ans = 0, notAns = 0, mark = 0, notVisit = 0;
        questions.forEach((_, i) => {
            const btn = document.createElement('div'); btn.className = 'question-number';
            const isAnswered = state.answers[i] !== null; const isMarked = state.marked[i];
            if(isAnswered && isMarked) btn.classList.add('marked-answered'); else if(isAnswered) btn.classList.add('answered');
            else if(isMarked) btn.classList.add('marked'); else if(state.visited[i]) btn.classList.add('not-answered');
            else btn.classList.add('not-visited');
            if (i === state.current) btn.classList.add('current');
            if (isAnswered) ans++; if (isMarked) mark++; if (!state.visited[i]) notVisit++;
            btn.textContent = i + 1; btn.onclick = () => { if (!isTestCompleted) loadQuestion(i); }; dom.questionPalette.appendChild(btn);
        });
        notAns = questions.length - ans - notVisit - (state.marked.filter((m,i) => m && !state.answers[i]).length);
        dom.summaryAnswered.textContent = ans; dom.summaryMarked.textContent = mark; dom.summaryNotAnswered.textContent = notAns; dom.summaryNotVisited.textContent = notVisit;
    }

    function updateNavigationButtons() { dom.btnPrevQuestion.style.display = state.current === 0 ? 'none' : 'flex'; }
    function formatTime(s) { return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }

    function startTimer() {
        clearInterval(mainTimerInterval);
        mainTimerInterval = setInterval(() => { if (timeLeft <= 0) { clearInterval(mainTimerInterval); submitTest(true); return; } timeLeft--; dom.timer.textContent = formatTime(timeLeft); }, 1000);
    }
    
    function startQuestionTimer() {
        if (onTimerEnd) dom.questionTimerBar.removeEventListener('transitionend', onTimerEnd);
        onTimerEnd = () => handleSaveAndNext();
        dom.questionTimerBar.style.transition = 'none'; dom.questionTimerBar.style.width = '100%';
        dom.questionTimerBar.offsetHeight; 
        dom.questionTimerBar.style.transition = `width ${PER_QUESTION_TIME}s linear`;
        dom.questionTimerBar.style.width = '0%';
        dom.questionTimerBar.addEventListener('transitionend', onTimerEnd, { once: true });
    }

    function stopTimer() { clearInterval(mainTimerInterval); if(onTimerEnd) dom.questionTimerBar.removeEventListener('transitionend', onTimerEnd); }
    
    function calculateTopicStats() {
      const stats = {}; questions.forEach((q, i) => {
        if (!stats[q.topic]) stats[q.topic] = { correct: 0, attempted: 0 };
        if (state.answers[i] !== null) { stats[q.topic].attempted++; if (state.answers[i] === q.answer) stats[q.topic].correct++; }
      }); return stats;
    }

    function showResultScreen(scoreText, topicStats) {
        dom.finalScore.textContent = scoreText; populatePerformanceTable(topicStats); 
        setTimeout(() => renderPerformanceChart(topicStats), 100);
    }

    function populatePerformanceTable(topicStats) {
        dom.performanceTableBody.innerHTML = ''; if (!topicStats) return;
        Object.keys(topicStats).forEach(topicName => {
            const stats = topicStats[topicName]; const acc = stats.attempted > 0 ? Math.round((stats.correct / stats.attempted) * 100) : 0;
            const barColor = acc > 75 ? '#4caf50' : acc >= 40 ? '#ff9800' : '#f44336';
            dom.performanceTableBody.innerHTML += `<tr><td>${topicName}</td><td>${stats.correct}</td><td>${stats.attempted}</td><td><div class="accuracy-bar-container"><div class="accuracy-bar" style="width:${acc}%;background-color:${barColor};"></div><span class="accuracy-text">${acc}%</span></div></td></tr>`;
        });
    }

    function renderPerformanceChart(topicStats) {
        if (performanceChart) performanceChart.destroy(); if (!topicStats) return;
        const isDark = document.body.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        const textColor = isDark ? 'rgba(255,255,255,0.7)' : '#666';
        const labels = Object.keys(topicStats); const marks = labels.map(l => topicStats[l].correct);
        const accuracy = labels.map(l => topicStats[l].attempted > 0 ? Math.round((topicStats[l].correct / topicStats[l].attempted) * 100) : 0);
        const ctx = document.getElementById('performanceChart').getContext('2d');
        performanceChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Correct Answers', data: marks, backgroundColor: '#3f51b5', yAxisID: 'y' }, { label: 'Accuracy (%)', data: accuracy, type: 'line', borderColor: '#4caf50', tension: 0.1, yAxisID: 'y1' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { type: 'linear', position: 'left', title: { display: true, text: 'Correct Answers', color: textColor }, ticks: { color: textColor, precision:0 }, grid: { color: gridColor }, beginAtZero: true }, y1: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: 'Accuracy (%)', color: textColor }, ticks: { color: textColor }, grid: { drawOnChartArea: false } } }, plugins: { legend: { labels: { color: textColor } } } } });
    }

    document.addEventListener('DOMContentLoaded', () => {
        dom.loginScreen.style.display = 'flex';
        dom.loginBtn.addEventListener('click', handleLogin);
        dom.startExamBtn.addEventListener('click', startExam);
        window.addEventListener('online', checkOnlineStatus); window.addEventListener('offline', checkOnlineStatus);
        
        dom.btnSaveNext.addEventListener('click', handleSaveAndNext);
        dom.btnPrevQuestion.addEventListener('click', () => { if(state.current > 0 && !isTestCompleted) loadQuestion(state.current - 1); });
        dom.btnMarkReview.addEventListener('click', handleMarkAndNext);
        dom.btnClearResponse.addEventListener('click', handleClearResponse);
        dom.btnSubmitTest.addEventListener('click', () => submitTest(false));
        dom.darkModeToggle.addEventListener('change', (e) => { document.body.classList.toggle('dark', e.target.checked); if (isTestCompleted) renderPerformanceChart(calculateTopicStats()); });
        dom.sidebarToggle.addEventListener('click', () => document.body.classList.toggle('sidebar-open'));
        checkOnlineStatus();
    });
  </script>
</body>
</html>
