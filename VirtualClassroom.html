<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UPSChub - Exam Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* General Styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: 'Poppins', sans-serif; background: #f0f0f5; color: #333; transition: background-color 0.3s ease, color 0.3s ease; }
    .dark { background: #1e1e2f; color: #eee; }

    /* Login Screen Styles */
    #loginScreen {
        display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh;
        padding: 20px; background: #f0f2f5;
    }
    .dark #loginScreen { background: #1a1a2e; }
    .login-card {
        background: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        width: 100%; max-width: 450px; text-align: center;
    }
    .dark .login-card { background: #2a2a3a; box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
    .login-card h2 { margin-bottom: 25px; color: #3f51b5; font-size: 1.8em; }
    .dark .login-card h2 { color: #8ab4f8; }
    .input-group { margin-bottom: 20px; text-align: left; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .input-group input { width: 100%; padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; }
    .dark .input-group input { background: #1e1e2f; border-color: #555; color: #eee; }
    .btn-primary { width: 100%; padding: 12px; border: none; border-radius: 6px; background: #3f51b5; color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.3s; }
    #loginError { color: #f44336; height: 1.2em; margin-top: 15px; font-weight: 500; }
    
    /* NEW: Full-Screen Instructions Page Styles */
    #instructionsScreen {
        display: none; flex-direction: column; height: 100vh; background: #fff;
    }
    .dark #instructionsScreen { background: #1a1a2e; }
    .instructions-header {
        padding: 15px 30px; text-align: center; background-color: #3f51b5; color: white;
    }
    .instructions-header h1 { font-size: 1.6em; }
    .instructions-content {
        flex-grow: 1; padding: 30px; overflow-y: auto;
    }
    .instructions-content h2 { color: #3f51b5; border-bottom: 2px solid #3f51b5; padding-bottom: 5px; margin-bottom: 15px; }
    .dark .instructions-content h2 { color: #8ab4f8; border-bottom-color: #8ab4f8; }
    .instructions-content ul { padding-left: 20px; margin-bottom: 25px; line-height: 1.8; }
    .instructions-content ul li { margin-bottom: 12px; }
    .instructions-content strong { color: #c62828; }
    .dark .instructions-content strong { color: #ef9a9a; }
    .instructions-footer {
        padding: 20px 30px; background: #f0f0f5; border-top: 1px solid #ddd;
    }
    .dark .instructions-footer { background: #2a2a3a; border-top-color: #444; }
    .agreement-group {
        display: flex; align-items: center; margin-bottom: 15px;
    }
    #agreementCheckbox { width: 18px; height: 18px; margin-right: 10px; }
    #agreementCheckbox + label { font-size: 0.9em; cursor: pointer; }
    .btn-start-exam {
        width: 100%; padding: 14px; font-size: 1.2em;
    }
    .btn-start-exam:disabled { background: #aab1d6; cursor: not-allowed; }
    #startError {
        color: #d32f2f; font-size: 0.9em; text-align: center; height: 1.2em; margin-top: 10px;
    }

    /* ==== EXAM UI STYLES (MATCHING THE REFERENCE) ==== */
    #examContainer { display: none; }
    body.exam-active::after { display: block; content: "UPSChub \AUPSChub \AUPSChub \A..."; }
    .container { display: flex; flex-direction: column; height: 100%; position: relative; }
    .site-header, .topbar, .main-content, .fixed-action-area {
        opacity: 0; animation: fadeIn 0.5s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; } }
    .site-header { background: #ffffff; padding: 10px 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 101; }
    .dark .site-header { background: #2a2a3a; border-color: #3a3a4a; }
    /* All other UI styles from previous version remain same... (minified for brevity) */
    .site-logo{height:40px}.site-branding .site-title{font-size:1.4em;font-weight:700;color:#3f51b5}.site-branding .site-tagline{font-size:.8em;color:#666}.topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 20px;background:#3f51b5;color:#fff;z-index:100}.timer{font-size:.95em;font-weight:700;background:rgba(0,0,0,.2);padding:4px 8px;border-radius:4px}.dark-mode-toggle{display:flex;align-items:center;gap:8px}.toggle-switch{position:relative;display:inline-block;width:50px;height:26px}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}.toggle-slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background-color:#fff;transition:.4s;border-radius:50%}input:checked+.toggle-slider{background-color:#4caf50}input:checked+.toggle-slider:before{transform:translateX(24px)}#btnSubmitTest{background:#f44336;border:none;border-radius:6px;padding:8px 15px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px}.main-content{flex:1;display:flex;overflow:hidden}.question-area{width:100%;padding:20px;overflow-y:auto;padding-bottom:100px;position:relative;z-index:5}.question-header{font-size:1.2em;font-weight:600;margin-bottom:15px}.question-timer-bar-container{width:100%;height:8px;background:#e0e0e0;border-radius:4px;margin-bottom:20px;overflow:hidden}.question-timer-bar{height:100%;width:100%;background:#3f51b5;border-radius:4px}.dark .question-timer-bar-container{background:#3d3d4a}.dark .question-timer-bar{background:#8ab4f8}.question-content{margin-bottom:20px}.options-list{list-style:none;display:grid;gap:10px}.option{padding:12px 15px;border:1px solid #ddd;border-radius:8px;cursor:pointer;background:#fff;display:flex;align-items:center}.dark .option{background:#2c2c3c;border-color:#444}.option.selected{background:#4caf50;color:#fff;border-color:#4caf50}.option-radio{margin-right:12px;min-width:18px;height:18px;border:2px solid #ccc;border-radius:50%}.option.selected .option-radio{border-color:#fff;background:#fff;box-shadow:inset 0 0 0 4px #4caf50}.sidebar{position:fixed;top:111px;right:-300px;width:300px;height:calc(100% - 111px);background:#f8f9fa;border-left:1px solid #ccc;display:flex;flex-direction:column;transition:right .3s ease-in-out;z-index:200}.dark .sidebar{background:#2a2a3a;border-left-color:#444}.sidebar-open .sidebar{right:0}.sidebar-content{padding:15px;overflow-y:auto;flex-grow:1}.palette-title{font-weight:600;margin-bottom:10px;color:#3f51b5;font-size:1.1em;text-align:center}.dark .palette-title{color:#8ab4f8}.question-palette{display:grid;grid-template-columns:repeat(auto-fill,minmax(35px,1fr));gap:8px;margin-bottom:20px}.question-number{width:35px;height:35px;display:flex;align-items:center;justify-content:center;border-radius:50%;cursor:pointer;font-weight:500;font-size:13px}.answered{background:#4caf50;color:#fff}.not-answered{background:#f44336;color:#fff}.marked{background:#ff9800;color:#fff}.marked-answered{background:linear-gradient(135deg,#4caf50 50%,#ff9800 50%);color:#fff}.not-visited{background:#e9ecef;color:#333;border:1px solid #ddd}.dark .not-visited{background:#3d3d4a;color:#eee}.current{border:2px solid #3f51b5}.sidebar-toggle{position:fixed;top:120px;right:15px;z-index:300;background:#3f51b5;border:none;border-radius:50%;width:40px;height:40px;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}.sidebar-open .sidebar-toggle{right:315px;transform:rotate(180deg)}.fixed-action-area{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:1px solid #ccc;padding:10px 15px;z-index:100}.action-buttons{display:flex;justify-content:center;gap:8px}.btn-action{padding:8px;border:none;border-radius:6px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;flex-grow:1}#btnPrevQuestion{background:#6c757d;color:#fff}#btnSaveNext{background:#4caf50;color:#fff}#btnMarkReview{background:#ff9800;color:#fff}#btnClearResponse{background:#f44336;color:#fff}#resultScreenWrapper{display:none;flex-direction:column;flex:1;overflow-y:auto;z-index:5;padding:20px}#resultScreenWrapper h2{text-align:center;color:#3f51b5}#finalScore{text-align:center;font-weight:700;font-size:2em;color:#4caf50}.performance-analysis-container{width:100%;max-width:800px;margin:30px auto;background:#fff;padding:25px;border-radius:12px}.dark .performance-analysis-container{background:#2a2a3a}.performance-table{width:100%;border-collapse:collapse}
  </style>
</head>
<body>

  <!-- STAGE 1: LOGIN SCREEN -->
  <div id="loginScreen" class="pre-exam-screen">
    <div class="login-card">
        <h2>Exam Portal Login</h2>
        <div class="input-group"> <label for="userIdInput">User ID</label> <input type="text" id="userIdInput" value="admin"> </div>
        <div class="input-group"> <label for="passwordLoginInput">Password</label> <input type="password" id="passwordLoginInput" value="password123"> </div>
        <button id="loginBtn" class="btn-primary">Login</button> <p id="loginError"></p>
    </div>
  </div>

  <!-- STAGE 2: INSTRUCTIONS SCREEN -->
  <div id="instructionsScreen" class="pre-exam-screen">
      <div class="instructions-header"><h1>Exam Instructions & Rules</h1></div>
      <div class="instructions-content">
          <h2>General Instructions:</h2>
          <ul>
              <li>Total Exam Duration: <strong>2 Hours 30 Minutes</strong> (This is a sample with 15 questions).</li>
              <li>The clock has been set at the server. The countdown timer at the top of the screen will display the remaining time available for you to complete the examination.</li>
              <li>Each question has a <strong>12-second timer</strong>. The test will automatically move to the next question when this timer ends.</li>
          </ul>
          <h2>Security & Environment:</h2>
          <ul>
              <li>You must take this exam in an offline environment. Please <strong>Enable Aeroplane/Flight Mode</strong> on your device before starting.</li>
              <li>Once the exam starts, if an internet connection is detected, your test will be <strong>automatically submitted</strong> immediately. This action is final.</li>
              <li>Do not close the browser window or refresh the page, as your progress will be lost.</li>
          </ul>
          <h2>Navigation Instructions:</h2>
          <ul>
              <li>Use the <strong>Save & Next</strong> button to save your answer and move to the next question. This is the primary method of navigation.</li>
              <li>Use the <strong>Previous</strong> button to navigate to the previous question.</li>
              <li>Click on a question number in the palette on the right to jump to that question.</li>
              <li>The <strong>Mark for Review</strong> button marks a question for later review. You can answer it and still mark it.</li>
          </ul>
      </div>
      <div class="instructions-footer">
          <div id="offlineStatus" class="status-waiting"><i class="fas fa-wifi"></i> Please turn on Aeroplane Mode to continue.</div>
          <div class="agreement-group">
              <input type="checkbox" id="agreementCheckbox">
              <label for="agreementCheckbox">I have read and understood all the instructions and agree to abide by the exam rules.</label>
          </div>
          <button id="startExamBtn" class="btn-primary btn-start-exam" disabled>Start Exam</button>
          <div id="startError"></div>
      </div>
  </div>

  <!-- STAGE 3: EXAM UI CONTAINER -->
  <div id="examContainer">
    <!-- Remainder of UI is loaded via JS or is standard from previous versions -->
  </div>

 <script>
    const CORRECT_USER_ID = "admin";
    const CORRECT_PASSWORD = "password123";
    const TEST_DURATION_SECONDS = 150 * 60; 
    const PER_QUESTION_TIME = 12; 
    const questions = [
        { topic: "Union & Territory", text: "Article 1 of the Constitution describes India as a:", options: ["Federation of States", "Union of States", "Confederation of States", "Quasi-Federal State"], answer: 1 },
        { topic: "Union & Territory", text: "The power to admit new states into the Union is vested in:", options: ["The President", "The Parliament", "The Supreme Court", "The Prime Minister"], answer: 1 },
        { topic: "Union & Territory", text: "The integration of princely states was primarily the responsibility of:", options: ["Jawaharlal Nehru", "Dr. B.R. Ambedkar", "Sardar Vallabhbhai Patel", "Lord Mountbatten"], answer: 2 },
        { topic: "Citizenship", text: "India's citizenship provisions are enshrined in which part of the Constitution?", options: ["Part I", "Part II", "Part III", "Part IV"], answer: 1 },
        { topic: "Citizenship", text: "Indian citizenship can be lost through:", options: ["Renunciation", "Termination", "Deprivation", "All of the above"], answer: 3 },
        { topic: "Citizenship", text: "The concept of single citizenship is adopted from:", options: ["USA", "Canada", "Australia", "Britain"], answer: 3 },
        { topic: "Fundamental Rights", text: "The Right to Equality is guaranteed under which articles?", options: ["14-18", "19-22", "23-24", "25-28"], answer: 0 },
        { topic: "Fundamental Rights", text: "Which writ is known as a bulwark of individual liberty against arbitrary detention?", options: ["Mandamus", "Habeas Corpus", "Certiorari", "Quo-Warranto"], answer: 1 },
        { topic: "Fundamental Rights", text: "Right to Education (Article 21A) was added by which constitutional amendment?", options: ["42nd", "44th", "86th", "91st"], answer: 2 },
        { topic: "DPSP", text: "Which part of the Constitution contains the Directive Principles of State Policy?", options: ["Part III", "Part IV", "Part V", "Part VI"], answer: 1 },
        { topic: "DPSP", text: "Organizing village panchayats (Article 40) is based on which ideology?", options: ["Socialistic", "Gandhian", "Liberal-Intellectual", "Communist"], answer: 1 },
        { topic: "DPSP", text: "Are Directive Principles enforceable in a court of law?", options: ["Yes", "No", "Only in certain cases", "At the discretion of the court"], answer: 1 },
        { topic: "Fundamental Duties", text: "Fundamental Duties were added by the recommendation of:", options: ["Sarkaria Commission", "Swaran Singh Committee", "M.M. Punchhi Commission", "Venkatachaliah Commission"], answer: 1 },
        { topic: "Fundamental Duties", text: "The duty to protect and improve the natural environment is mentioned under:", options: ["Fundamental Rights", "DPSP", "Fundamental Duties", "Both DPSP and Fundamental Duties"], answer: 3 },
        { topic: "Fundamental Duties", text: "Which one of the following is NOT a Fundamental Duty?", options: ["To abide by the constitution", "To protect public property", "To cast a vote", "To promote harmony"], answer: 2 }
    ];
    
    let state = {}, onTimerEnd, mainTimerInterval, timeLeft = TEST_DURATION_SECONDS, isTestCompleted = false, performanceChart;
    
    const dom = {
        body: document.body,
        loginScreen: document.getElementById('loginScreen'), instructionsScreen: document.getElementById('instructionsScreen'),
        examContainer: document.getElementById('examContainer'), loginBtn: document.getElementById('loginBtn'),
        userIdInput: document.getElementById('userIdInput'), passwordInput: document.getElementById('passwordLoginInput'),
        loginError: document.getElementById('loginError'), startExamBtn: document.getElementById('startExamBtn'),
        offlineStatus: document.getElementById('offlineStatus'), agreementCheckbox: document.getElementById('agreementCheckbox'),
        startError: document.getElementById('startError')
    };

    const EXAM_UI_TEMPLATE = `
        <div class="container">
          <header class="site-header">
            <img src="https://via.placeholder.com/150x50/3f51b5/ffffff?text=LOGO" alt="UPSChub Logo" class="site-logo">
            <div class="site-branding"> <div class="site-title">UPSChub</div> <p class="site-tagline">Civil Services Exam Preparation</p> </div>
          </header>
          <header class="topbar">
            <div class="topbar-left-group"> <div class="timer" id="timer">${formatTime(TEST_DURATION_SECONDS)}</div> </div>
            <div class="topbar-right-group">
              <div class="dark-mode-toggle"> <span class="toggle-label">Dark</span> <label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="toggle-slider"></span></label> </div>
              <button id="btnSubmitTest"><i class="fas fa-paper-plane"></i> Submit</button>
            </div>
          </header>
          <div class="main-content">
            <div id="mockTestWrapper" style="display: flex; width: 100%;">
              <button id="btnToggleSidebar" class="sidebar-toggle"><i class="fas fa-chevron-left"></i></button>
              <section class="question-area">
                <h2 class="question-header" id="questionNumber"></h2>
                <div class="question-timer-bar-container"> <div id="questionTimerBar" class="question-timer-bar"></div> </div>
                <div class="question-content" id="questionText"></div> <ul class="options-list" id="optionsList"></ul>
              </section>
              <aside class="sidebar">
                <div class="sidebar-content"> <div class="palette-title">Question Palette</div> <div class="question-palette" id="questionPalette"></div> </div>
              </aside>
            </div>
            <div id="resultScreenWrapper" style="display:none">
              <h2>Test Completed!</h2><p>Your final score is:</p><p id="finalScore">0/0</p>
              <div class="performance-analysis-container"><canvas id="performanceChart"></canvas></div>
            </div>
          </div>
          <div class="fixed-action-area" id="mcqFooter">
            <div class="action-buttons">
              <button class="btn-action" id="btnPrevQuestion"><i class="fas fa-arrow-left"></i><span>Previous</span></button>
              <button class="btn-action" id="btnClearResponse"><i class="fas fa-ban"></i><span>Clear</span></button>
              <button class="btn-action" id="btnMarkReview"><i class="fas fa-flag"></i><span>Mark</span></button>
              <button class="btn-action" id="btnSaveNext"><i class="fas fa-check"></i><span>Save & Next</span></button>
            </div>
          </div>
        </div>`;

    function handleLogin() {
        if (dom.userIdInput.value === CORRECT_USER_ID && dom.passwordInput.value === CORRECT_PASSWORD) {
            dom.loginScreen.style.display = 'none'; dom.instructionsScreen.style.display = 'flex';
        } else { dom.loginError.textContent = 'Invalid User ID or Password.'; }
    }
    
    function validateStartConditions() {
        const isOffline = !navigator.onLine;
        const isAgreed = dom.agreementCheckbox.checked;
        dom.startExamBtn.disabled = !(isOffline && isAgreed);

        let errorMsg = '';
        if (!isOffline && !isAgreed) errorMsg = 'Please agree to the terms and enable Aeroplane Mode.';
        else if (!isOffline) errorMsg = 'Please enable Aeroplane Mode to continue.';
        else if (!isAgreed) errorMsg = 'Please agree to the instructions to start.';
        dom.startError.textContent = errorMsg;

        if (isOffline) dom.offlineStatus.innerHTML = '<i class="fas fa-check-circle"></i> You are offline. Ready to begin.';
        else dom.offlineStatus.innerHTML = '<i class="fas fa-wifi"></i> Please turn on Aeroplane Mode to continue.';
        dom.offlineStatus.className = isOffline ? 'status-ready' : 'status-waiting';
    }

    function forceSubmitOnReconnect() { if (!isTestCompleted) { alert("Internet connection detected. Submitting the test automatically as per exam rules."); submitTest(true); } }
    
    function startExam() {
        if(dom.startExamBtn.disabled) return;
        dom.instructionsScreen.style.display = 'none';
        dom.examContainer.innerHTML = EXAM_UI_TEMPLATE;
        dom.examContainer.style.display = 'block'; document.body.classList.add('exam-active');
        
        // Re-initialize DOM object for newly created elements
        Object.assign(dom, {
            mockTestWrapper: document.getElementById('mockTestWrapper'), resultScreenWrapper: document.getElementById('resultScreenWrapper'),
            mcqFooter: document.getElementById('mcqFooter'), questionText: document.getElementById('questionText'),
            questionNumber: document.getElementById('questionNumber'), questionTimerBar: document.getElementById('questionTimerBar'),
            optionsList: document.getElementById('optionsList'), questionPalette: document.getElementById('questionPalette'),
            btnSubmitTest: document.getElementById('btnSubmitTest'), btnPrevQuestion: document.getElementById('btnPrevQuestion'),
            btnSaveNext: document.getElementById('btnSaveNext'), btnMarkReview: document.getElementById('btnMarkReview'),
            btnClearResponse: document.getElementById('btnClearResponse'), timer: document.getElementById('timer'),
            darkModeToggle: document.getElementById('darkModeToggle'), finalScore: document.getElementById('finalScore'),
            performanceTableBody: document.querySelector('#resultScreenWrapper tbody'),
            sidebarToggle: document.getElementById('btnToggleSidebar')
        });

        // Add event listeners for new elements
        addExamEventListeners();
        
        window.removeEventListener('online', validateStartConditions); window.removeEventListener('offline', validateStartConditions);
        window.addEventListener('online', forceSubmitOnReconnect); initTest();
    }

    function addExamEventListeners() {
        dom.btnSaveNext.addEventListener('click', handleSaveAndNext);
        dom.btnPrevQuestion.addEventListener('click', () => { if(state.current > 0 && !isTestCompleted) loadQuestion(state.current - 1); });
        dom.btnMarkReview.addEventListener('click', handleMarkAndNext);
        dom.btnClearResponse.addEventListener('click', handleClearResponse);
        dom.btnSubmitTest.addEventListener('click', () => submitTest(false));
        dom.darkModeToggle.addEventListener('change', (e) => { dom.body.classList.toggle('dark', e.target.checked); if (isTestCompleted) renderPerformanceChart(calculateTopicStats()); });
        dom.sidebarToggle.addEventListener('click', () => dom.body.classList.toggle('sidebar-open'));
    }

    function initTest() { resetState(); isTestCompleted = false; timeLeft = TEST_DURATION_SECONDS; state.visited[0] = true; loadQuestion(0); startTimer(); }
    function resetState() { state = { current: 0, answers: Array(questions.length).fill(null), marked: Array(questions.length).fill(false), visited: Array(questions.length).fill(false) }; }
    
    function loadQuestion(index) {
        state.current = index; if (!state.visited[index]) { state.visited[index] = true; }
        startQuestionTimer();
        const q = questions[index];
        dom.questionNumber.textContent = `Question ${index + 1}`;
        dom.questionText.textContent = q.text; dom.optionsList.innerHTML = '';
        q.options.forEach((opt, i) => {
            const li = document.createElement('li'); li.className = 'option'; if (state.answers[index] === i) li.classList.add('selected');
            li.innerHTML = `<span class="option-radio"></span><span class="option-text">${opt}</span>`;
            li.onclick = () => selectOption(i); dom.optionsList.appendChild(li);
        });
        dom.btnSubmitTest.style.display = (state.current === questions.length - 1) ? 'flex' : 'none';
        updatePalette(); updateNavigationButtons();
    }

    function selectOption(optIndex) {
        state.answers[state.current] = optIndex;
        dom.optionsList.querySelectorAll('.option').forEach((opt, i) => opt.classList.toggle('selected', i === optIndex));
        updatePalette();
    }

    function handleSaveAndNext() { if (isTestCompleted) return; if (state.current < questions.length - 1) loadQuestion(state.current + 1); else submitTest(true); }
    function handleMarkAndNext() { if (isTestCompleted) return; state.marked[state.current] = true; handleSaveAndNext(); }
    function handleClearResponse() { state.answers[state.current] = null; dom.optionsList.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected')); updatePalette(); }
    
    function submitTest(isForced = false) {
        if (isTestCompleted) return;
        if (!isForced && !confirm('Are you sure you want to submit the test?')) return;
        stopTimer(); isTestCompleted = true; window.removeEventListener('online', forceSubmitOnReconnect);
        
        const score = state.answers.reduce((acc, ans, i) => (ans === questions[i].answer ? acc + 1 : acc), 0);
        
        dom.mockTestWrapper.style.display = 'none'; dom.mcqFooter.style.display = 'none';
        dom.sidebarToggle.style.display = 'none'; dom.body.classList.remove('sidebar-open');
        showResultScreen(`${score} / ${questions.length}`, calculateTopicStats());
        dom.resultScreenWrapper.style.display = 'flex';
    }
    
    function updatePalette() {
        dom.questionPalette.innerHTML = '';
        questions.forEach((_, i) => {
            const btn = document.createElement('div'); btn.className = 'question-number';
            const isAnswered = state.answers[i] !== null; const isMarked = state.marked[i];
            if(isAnswered && isMarked) btn.classList.add('marked-answered'); else if(isAnswered) btn.classList.add('answered');
            else if(isMarked) btn.classList.add('marked'); else if(state.visited[i]) btn.classList.add('not-answered');
            else btn.classList.add('not-visited');
            if (i === state.current) btn.classList.add('current');
            btn.textContent = i + 1; btn.onclick = () => { if (!isTestCompleted) loadQuestion(i); }; dom.questionPalette.appendChild(btn);
        });
    }

    function updateNavigationButtons() { dom.btnPrevQuestion.style.display = state.current === 0 ? 'none' : 'flex'; }
    function formatTime(s) { return `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }

    function startTimer() {
        clearInterval(mainTimerInterval);
        mainTimerInterval = setInterval(() => { if (timeLeft <= 0) { clearInterval(mainTimerInterval); submitTest(true); return; } timeLeft--; dom.timer.textContent = formatTime(timeLeft); }, 1000);
    }
    
    function startQuestionTimer() {
        if (onTimerEnd) dom.questionTimerBar.removeEventListener('transitionend', onTimerEnd);
        onTimerEnd = () => handleSaveAndNext();
        dom.questionTimerBar.style.transition = 'none'; dom.questionTimerBar.style.width = '100%';
        dom.questionTimerBar.offsetHeight; 
        dom.questionTimerBar.style.transition = `width ${PER_QUESTION_TIME}s linear`;
        dom.questionTimerBar.style.width = '0%';
        dom.questionTimerBar.addEventListener('transitionend', onTimerEnd, { once: true });
    }

    function stopTimer() { clearInterval(mainTimerInterval); if(onTimerEnd) dom.questionTimerBar.removeEventListener('transitionend', onTimerEnd); }
    
    function calculateTopicStats() {
      const stats = {}; questions.forEach((q, i) => {
        if (!stats[q.topic]) stats[q.topic] = { correct: 0, attempted: 0 };
        if (state.answers[i] !== null) { stats[q.topic].attempted++; if (state.answers[i] === q.answer) stats[q.topic].correct++; }
      }); return stats;
    }

    function showResultScreen(scoreText, topicStats) {
        dom.finalScore.textContent = scoreText;
        if(dom.performanceTableBody) {
             // populatePerformanceTable is not available in the minified version for brevity. You can add it back if needed.
        }
        setTimeout(() => renderPerformanceChart(topicStats), 100);
    }

    function renderPerformanceChart(topicStats) {
        const chartCanvas = document.getElementById('performanceChart');
        if (!chartCanvas) return;
        if (performanceChart) performanceChart.destroy(); if (!topicStats) return;
        const isDark = document.body.classList.contains('dark');
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        const textColor = isDark ? 'rgba(255,255,255,0.7)' : '#666';
        const labels = Object.keys(topicStats); const marks = labels.map(l => topicStats[l].correct);
        const accuracy = labels.map(l => topicStats[l].attempted > 0 ? Math.round((topicStats[l].correct / topicStats[l].attempted) * 100) : 0);
        const ctx = chartCanvas.getContext('2d');
        performanceChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Correct Answers', data: marks, backgroundColor: '#3f51b5', yAxisID: 'y' }, { label: 'Accuracy (%)', data: accuracy, type: 'line', borderColor: '#4caf50', tension: 0.1, yAxisID: 'y1' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { color: gridColor } }, y: { type: 'linear', position: 'left', title: { display: true, text: 'Correct Answers', color: textColor }, ticks: { color: textColor, precision:0 }, grid: { color: gridColor }, beginAtZero: true }, y1: { type: 'linear', position: 'right', min: 0, max: 100, title: { display: true, text: 'Accuracy (%)', color: textColor }, ticks: { color: textColor }, grid: { drawOnChartArea: false } } }, plugins: { legend: { labels: { color: textColor } } } } });
    }

    document.addEventListener('DOMContentLoaded', () => {
        dom.loginScreen.style.display = 'flex';
        dom.loginBtn.addEventListener('click', handleLogin);
        dom.startExamBtn.addEventListener('click', startExam);
        window.addEventListener('online', validateStartConditions); window.addEventListener('offline', validateStartConditions);
        dom.agreementCheckbox.addEventListener('change', validateStartConditions);
        validateStartConditions();
    });
  </script>
</body>
</html>
